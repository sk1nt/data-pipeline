name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint_and_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install duckdb pandas requests pytest ruff
      - name: Lint (ruff)
        run: ruff check .
      - name: Run tests
        run: pytest -q

  benchmark:
    needs: lint_and_tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install duckdb pandas requests
      - name: Run import benchmark
        run: |
          python scripts/bench/bench_import.py --records 1000

  volume_bar_smoke:
    needs: lint_and_tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install duckdb pandas joblib scikit-learn lightgbm pytest
      - name: Fast volume bar smoke test
        env:
          MLFLOW_TRACKING_URI: sqlite:///ml/mlflow.db
          MLFLOW_ARTIFACT_ROOT: file:ml/mlruns
        run: |
          set -euo pipefail
          # Small day used for CI (fast)
          DATE=20251006
          # Extract volume bars at 1000-unit size
          python -m ml.extract --symbol MNQ --date $DATE --gex-db data/gex_data.db --bar-type volume --bar-size 1000
          # Preprocess the created volume bars into a dataset
          python -m ml.preprocess --inputs ml/output/MNQ_${DATE}_volume1000.parquet --window 60 --stride 2 --horizon 1
          # Run a small subsampled backtest (sample limits windows to 200) using LightGBM to avoid heavy GPU
          python -m ml.pnl_backtest --mlflow --experiment ci_volume_smoke --model ml/models/lightgbm_tuned.pkl --days $DATE --window 60 --threshold 0.5 --instrument MNQ --bar-type volume --bar-size 1000 --sample 200 --stride 2
          # Assertions: mlruns must live under ml/, and no root-level mlruns
          if [ ! -d "ml/mlruns" ]; then echo "ml/mlruns not found"; exit 2; fi
          if [ -e "mlruns" ]; then echo "root-level mlruns directory exists"; exit 3; fi
