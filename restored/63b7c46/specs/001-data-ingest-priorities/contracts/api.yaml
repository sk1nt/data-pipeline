openapi: 3.0.3
info:
  title: GEX Data Ingest Priority API
  description: API for managing high-speed GEX data ingestion with priority-based processing
  version: 1.0.0
  contact:
    name: Data Pipeline Team

servers:
  - url: http://localhost:8000/api/v1
    description: Development server
  - url: https://api.data-pipeline.com/v1
    description: Production server

paths:
  /ingest/priority:
    post:
      summary: Submit GEX data for priority-based ingestion
      description: Submit a GEX data source URL for processing with automatic priority assignment
      operationId: submitPriorityIngest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PriorityIngestRequest'
            example:
              source_url: "https://api.gexbot.com/ndx/gex-history"
              data_type: "historical"
              market_symbol: "NDX"
              metadata:
                expected_records: 10000
                data_quality: "high"
      responses:
        '202':
          description: Request accepted for processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PriorityIngestResponse'
              example:
                request_id: "123e4567-e89b-12d3-a456-426614174000"
                priority_level: "HIGH"
                estimated_processing_time: "00:05:00"
                queue_position: 3
        '400':
          description: Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ingest/priority/{request_id}:
    get:
      summary: Get priority ingest request status
      description: Retrieve the current status and details of a priority ingest request
      operationId: getPriorityIngestStatus
      parameters:
        - name: request_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Unique identifier of the priority request
      responses:
        '200':
          description: Request status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PriorityIngestStatus'
              example:
                request_id: "123e4567-e89b-12d3-a456-426614174000"
                status: "PROCESSING"
                priority_level: "HIGH"
                submitted_at: "2025-11-09T10:30:00Z"
                started_at: "2025-11-09T10:30:15Z"
                records_processed: 7500
                estimated_completion: "2025-11-09T10:35:00Z"
        '404':
          description: Request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ingest/priority/queue:
    get:
      summary: Get priority queue status
      description: Retrieve current priority queue statistics and pending requests
      operationId: getPriorityQueueStatus
      responses:
        '200':
          description: Queue status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueStatus'
              example:
                total_queued: 15
                by_priority:
                  CRITICAL: 2
                  HIGH: 5
                  MEDIUM: 6
                  LOW: 2
                oldest_request: "2025-11-09T10:25:00Z"
                processing_capacity: 4

  /sources:
    get:
      summary: List data sources
      description: Retrieve list of configured GEX data sources with reliability metrics
      operationId: listDataSources
      parameters:
        - name: active_only
          in: query
          schema:
            type: boolean
            default: true
          description: Filter to active sources only
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Maximum number of sources to return
      responses:
        '200':
          description: Sources retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataSourceList'
              example:
                sources:
                  - source_id: "456e7890-e89b-12d3-a456-426614174001"
                    name: "GEXBot NDX"
                    base_url: "https://api.gexbot.com"
                    reliability_score: 0.95
                    is_active: true
                    total_requests: 1250
                    successful_requests: 1188
                total_count: 1

  /rules:
    get:
      summary: List priority rules
      description: Retrieve active priority assignment rules
      operationId: listPriorityRules
      responses:
        '200':
          description: Rules retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PriorityRuleList'
              example:
                rules:
                  - rule_id: "789e0123-e89b-12d3-a456-426614174002"
                    name: "High Priority Real-time Data"
                    description: "Prioritize real-time data for major indices"
                    priority_score: 0.9
                    is_active: true
                total_count: 1

components:
  schemas:
    PriorityIngestRequest:
      type: object
      required:
        - source_url
        - data_type
        - market_symbol
      properties:
        source_url:
          type: string
          format: uri
          description: URL of the GEX data source
        data_type:
          $ref: '#/components/schemas/GEXDataType'
        market_symbol:
          type: string
          minLength: 1
          maxLength: 10
          description: Underlying market symbol
        metadata:
          type: object
          description: Additional request metadata
          additionalProperties: true

    PriorityIngestResponse:
      type: object
      required:
        - request_id
        - priority_level
        - estimated_processing_time
        - queue_position
      properties:
        request_id:
          type: string
          format: uuid
          description: Unique request identifier
        priority_level:
          $ref: '#/components/schemas/PriorityLevel'
        estimated_processing_time:
          type: string
          format: duration
          description: Estimated processing time (ISO 8601 duration)
        queue_position:
          type: integer
          minimum: 1
          description: Current position in priority queue

    PriorityIngestStatus:
      type: object
      required:
        - request_id
        - status
        - priority_level
        - submitted_at
      properties:
        request_id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/JobStatus'
        priority_level:
          $ref: '#/components/schemas/PriorityLevel'
        submitted_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        records_processed:
          type: integer
          minimum: 0
        estimated_completion:
          type: string
          format: date-time
        error_message:
          type: string

    QueueStatus:
      type: object
      required:
        - total_queued
        - by_priority
      properties:
        total_queued:
          type: integer
          minimum: 0
        by_priority:
          type: object
          properties:
            CRITICAL:
              type: integer
              minimum: 0
            HIGH:
              type: integer
              minimum: 0
            MEDIUM:
              type: integer
              minimum: 0
            LOW:
              type: integer
              minimum: 0
        oldest_request:
          type: string
          format: date-time
        processing_capacity:
          type: integer
          minimum: 0

    DataSourceList:
      type: object
      required:
        - sources
        - total_count
      properties:
        sources:
          type: array
          items:
            $ref: '#/components/schemas/DataSource'
        total_count:
          type: integer
          minimum: 0

    DataSource:
      type: object
      required:
        - source_id
        - name
        - base_url
        - reliability_score
        - is_active
      properties:
        source_id:
          type: string
          format: uuid
        name:
          type: string
        base_url:
          type: string
          format: uri
        reliability_score:
          type: number
          minimum: 0.0
          maximum: 1.0
        is_active:
          type: boolean
        total_requests:
          type: integer
          minimum: 0
        successful_requests:
          type: integer
          minimum: 0

    PriorityRuleList:
      type: object
      required:
        - rules
        - total_count
      properties:
        rules:
          type: array
          items:
            $ref: '#/components/schemas/PriorityRule'
        total_count:
          type: integer
          minimum: 0

    PriorityRule:
      type: object
      required:
        - rule_id
        - name
        - priority_score
        - is_active
      properties:
        rule_id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        priority_score:
          type: number
          minimum: 0.0
          maximum: 1.0
        is_active:
          type: boolean

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error details

    GEXDataType:
      type: string
      enum:
        - historical
        - real_time
        - snapshot

    PriorityLevel:
      type: string
      enum:
        - CRITICAL
        - HIGH
        - MEDIUM
        - LOW

    JobStatus:
      type: string
      enum:
        - QUEUED
        - PROCESSING
        - COMPLETED
        - FAILED

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
    BearerAuth:
      type: http
      scheme: bearer

security:
  - ApiKeyAuth: []
  - BearerAuth: []